# Running Zephyr on the IG60-BL654

This tutorial is a walk-through for the end user on how to get Zephyr apps running on the IG60-BL654 and publish the data generated by the app to AWS.
The OS used to run this tutorial is Ubuntu 18.04.

1.  Set up zephyr for building applications with the [Getting Started Guide](https://docs.zephyrproject.org/latest/getting_started/index.html)

  - The recommended starting version is [2.3.0](https://github.com/zephyrproject-rtos/zephyr/tree/zephyr-v2.3.0)
  - In step 5- Build the Blinky Sample use 'bl654_vdvk' for <your-board-name>
    * NOTE: If the build step isn't working properly check these two items:

        Don't forget to export these env vars or add them to your path
  
        ```
        # export ZEPHYR_TOOLCHAIN_VARIANT=zephyr
        # export ZEPHYR_SDK_INSTALL_DIR=~/zephyr-sdk-0.11.2
        ```

        You may need to update the dtc in order to build the app

        ```
        # wget http://mirrors.kernel.org/ubuntu/pool/main/d/device-tree-compiler/device-tree-compiler_1.4.7-3ubuntu2_amd64.deb
        # sudo apt install ./device-tree-compiler_1.4.7-3ubuntu2_amd64.deb
        ```
   

2.  Patch the bluetooth sample app
  - Add this line to the bl654_dvk_defconfig in the Zephyr source. In boards/arm/bl654_dvk/bl654_dvk_defconfig:

    ```
    CONFIG_FLASH_LOAD_OFFSET=0x1000
    ```

  - The Zephyr source code contains a sample application that will advertise our BL654 and also scan for Ble devices. Modify the sample app in the zephyr source via a patch in order to generate some json content that will be sent to the /dev/ttyS2 device on the IG60.  Later, we will fetch this json in order to publish the device data in a Lambda.  
  
  - Apply this patch to the scan_adv app in zephyr/samples/bluetooth/scan_adv/src/main.c:

    ```
    diff --git a/samples/bluetooth/scan_adv/src/main.c b/samples/bluetooth/scan_adv/src/main.c
    index 3dd80c0dfa..207cf00ad9 100644
    --- a/samples/bluetooth/scan_adv/src/main.c
    +++ b/samples/bluetooth/scan_adv/src/main.c
    @@ -23,14 +23,20 @@ static const struct bt_data ad[] = {
    static void scan_cb(const bt_addr_le_t *addr, s8_t rssi, u8_t adv_type,
                struct net_buf_simple *buf)
    {
    +
    +    printk("{ \"mac\" : \"%02X:%02X:%02X:%02X:%02X:%02X\", \"rssi\" : %d, \"adv_type\" : %u }\n",\ 
    +              addr->a.val[0], addr->a.val[1], addr->a.val[2], addr->a.val[3],\ 
    +            addr->a.val[4], addr->a.val[5], rssi, adv_type);
        mfg_data[2]++;
    +    
    +
    }
  
    void main(void)
    {
      struct bt_le_scan_param scan_param = {
          .type       = BT_HCI_LE_SCAN_PASSIVE,
    -        .options    = BT_LE_SCAN_OPT_NONE,
    +        .options    = BT_LE_SCAN_OPT_FILTER_DUPLICATE,
          .interval   = 0x0010,
          .window     = 0x0010,
      };
    ```
  - Copy the patch into a file called ble_demo.patch.  From the root of the zephyr tree apply the patch:

    ```
    ~/zephyrproject/zephyr$ git apply ble_demo.patch
    ```

3. Build the scan_adv sample application:
  
    ```
    # west build -b bl654_dvk samples/bluetooth/scan_adv --pristine
    ```

4. Package and upload the application

  - Packaging the hex file can be done with an application called 'UBUtil'.  Which can be found here: [UBUtil](https://github.com/LairdCP/ubutil)

  - Using the generated .hex file from the previous section, follow the [Generating Firmware Updates](https://documentation.lairdconnect.com/Builds/IG60-BL654-GREENGRASS/latest/Content/Topics/6%20-%20Software%20Reference/BL654%20Programming%20Guide/Generating%20Firmware%20Updates.htm) guide in order to create a package that can be installed on the BL654 in the IG60.

## For the Greengrass variant of the IG60-BL654

  Knowing how to create and package a lambda function is a pre-requisite for these next steps.  This guide assumes you have completed these tasks: [Create and Package a Lambda Function](https://documentation.lairdconnect.com/Builds/IG60-BL654-GREENGRASS/latest/Content/Topics/5%20-%20Using%20the%20Device/Greengrass%20Getting%20Started/Create%20and%20Package%20a%20Lambda%20Function.htm)

  - Install the newly generated package on the IG60 using the [fwloader lambda](https://github.com/LairdCP/igsdk/blob/master/aws/lambdas/bluetooth5/fwloader/fwloader.py)

  - Publish data to AWS using the [blescanner lambda](https://github.com/LairdCP/igsdk/tree/master/aws/lambdas/bluetooth5/blescanner)

## For the Summit Linux variant of the IG60-BL654

Once you create the firmware update, copy the UBU file to the IG60 (e.g., using a method such as 'scp' to remote copy, or transfer via removeable storage such as an SD card).  

  - You can then use the firmware upload utility in the IG60 firmware as described in the BL654 Firmware Loader to upload the file; e.g.:
  
  ```
  btpa_firmware_loader.py /dev/ttyS2 115200 myFirmware.ubu IG60 
  ```
  - You can see the output of the application by using the 'cat' command on the serial port:

  ```
  # cat /dev/ttyS2 &
  { "mac" : "75:0b:b0:fb:65:e8", "rssi" : -27, "adv_type" : 0 }
  { "mac" : "ba:9e:70:c0:6d:0e", "rssi" : -37, "adv_type" : 3 }
  { "mac" : "8f:b4:f8:61:e0:69", "rssi" : -72, "adv_type" : 2 }
  { "mac" : "91:08:b8:39:85:7d", "rssi" : -62, "adv_type" : 0 }
  { "mac" : "d6:27:fe:43:43:43", "rssi" : -45, "adv_type" : 2 }
  { "mac" : "c1:4d:6a:1e:d4:41", "rssi" : -71, "adv_type" : 2 }
  { "mac" : "60:8f:6f:eb:d3:63", "rssi" : -56, "adv_type" : 2 }
  { "mac" : "bf:f8:44:40:ee:c0", "rssi" : -31, "adv_type" : 0 }
  { "mac" : "7f:ad:44:49:53:67", "rssi" : -70, "adv_type" : 2 }
  ```
